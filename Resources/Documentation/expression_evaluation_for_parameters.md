
# Expression evaluation for parameters
In Luna Service, ISV can configure the offer, provision Azure resources automatically using ARM templates or webhook. See the [offer configuration documentation](configure_and_manage_offer.md) for more details about ARM templates and webhook in a Luna offer.
When Luna service deploying ARM template or calling, it will pass in the value of ARM template parameters or the query parameter in the webhook URL. The value of parameters carries the information about the offer, plan, subscription or operation. Some information, for example, the resource group name will never change after the subscription is created. The other ones, for example, the operation type, changes according to the life stage of the subscription or the user operation. In Luna service, ISV will define input parameters for ARM template and webhooks value using C# expressions. In this document, we will introduce how the parameters work, and how the values of parameters are evaluated.

## Type of parameters
- Offer parameters – The offer parameters are defined by the ISV when creating the offer in the “parameters” tab. Its value is provided by the user on the landing page when they subscribe the application [TODO: add link]. For example, ISV can define an offer parameter with name “region”. And user will specify which region their application will be deployed to. 
- ARM template parameters – When ISV upload ARM templates to Luna service, we extract all parameters from the ARM templates. Two additional ARM template parameters are created if any ARM template is uploaded: ResourceGroupLocation indicating the Azure region where the resource group will be deployed to; and EntryPointUrl indicating the url where user can access the application. 
- Webhook parameters – When ISV upload the webhook url, we extract all query parameters where value is in a pair of brackets (for example, a webhook parameter with name “userEmail” will be generated from email={userEmail}). 
- System parameters – These parameters are predefined and automatically generated by Luna service. It provides information about the current subscription and operation. The available system parameters are:

| **Name** | **Type** | **Description** |
| --- | --- | --- |
|system$$offerName|string|The name of the offer of current subscription|
|system$$subscriptionOwner|string|The email of the owner of the current subscription|
|system$$subscriptionId|Guid|The id of the current subscription|
|system$$planName|string|The name of the current plan for the current subscription|
|system$$operationType|string|The name of the current operation. It can be one of the following values: `Subscribe`, `Update`, `Suspend`, `Reinstate`, `Unsubscribe`, `DeleteData`|

## Parameter value in subscription lifecycle
According to the type of the parameter, the value of the parameter will be assigned and updated in different stage of the subscription lifecycle.

**Value of offer parameters** will be assigned when the subscription is created. The value of offer parameters will never change for a specific subscription.

**Value of ARM template parameters** and webhook parameters will be created the first time when one of the following provisioning operations occurs:
- Create resource group
- Deploy ARM template
- Trigger webhook

Once the value of ARM template or webhook parameter is assigned, it will never change. If you are adding any new webhook or ARM template parameters to the offer after the subscription is created, the value of new parameters will be evaluated and assigned next time when one of those three provisioning operation occurs. The value of existing parameters will not be updated.

**Value of system parameters** are dynamically generated. For example, the value of system$$planName will be the current plan of the specific subscription. If the user changed the plan of the subscription, the parameter value will also be changed. 

## Value Assignment
ISV can specify value of ARM template parameters or webhook parameters as C# expressions. 

### Built-in functions
When defining the parameter value, you can use the pre-defined functions which is built-in in the service. You will call the function as Context.function_name(function_parameters).

The following functions are available:

| **Function name** | **Description** | **Parameters** | **Return Value** | 
| --- | --- | --- | --- |
| GetRandomString | Generate a random string with specified length | **Length** (int32) – the length of the random string | A random string with only letters or numbers | 
| GetIpRange | Allocate ip addresses from the pre-defined ip blocks and assign to current subscription.  | **offerName** (string) – the value should always be Parameter[“system$$offerName”] <br/> **subscriptionId** (Guid) – the value should always be Parameter[“system$$subscriptionId”] <br/> **ipBlockName** (string) – the name of the Ip blocks defined in the “IP Addresses” tab. | The ip addresses in IPv4 CIDR format |

### Reference value of other parameters
When defining the parameter value, you can reference the value of other parameters by using the expression Parameters[“parameter_name”]. If there are multiple parameter referencing other parameters, the service will automatically detect the order during evaluation. If circular reference is detected, the evaluation will fail. 

## Examples
### Assign a fixed string to the parameter
```csharp
"somestring"
```
### Generate a random string with length of 12
```csharp
Context.GetRandomString(12)
```
### Allocate ip address from the ip block “vmIpBlock”
```csharp
Context.GetIpRange(Parameters[“system$$offerName”], Parameters[“system$$subscriptionId”], “vmIpBlock”)
```
### Compose name of the storage account using “namesuffix” parameter
```csharp
“storage”+Parameters[“namesuffix”]
```
### Use system parameter to send a welcome email to the subscription 
```csharp
Parameters[“system$$subscriptionOwner”]
```
### Use offer parameter “region” to decide where the resource group is going to deployed to
```csharp
Parameters[“region”]
```
